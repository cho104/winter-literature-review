name: Batch Command Processor
on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  process-batch:
    if: startsWith(github.event.issue.title, 'batch:')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Database
        uses: actions/checkout@v3

      - name: Process Command Queue
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let batch;
            try { batch = JSON.parse(context.payload.issue.body); } 
            catch (e) { console.log("Invalid JSON"); return; }

            let data = JSON.parse(fs.readFileSync('data.json', 'utf8'));
            let modified = false;

            // --- HELPERS ---
            const findFile = (items, url) => {
                for (let item of items) {
                    if (item.type === 'file' && item.url === url) return item;
                    if (item.type === 'folder') {
                        const found = findFile(item.children, url);
                        if (found) return found;
                    }
                }
                return null;
            };

            const findParentFolder = (items, url) => {
                for (let item of items) {
                    if (item.type === 'folder') {
                        if (item.children.some(child => child.type === 'file' && child.url === url)) return item;
                        const found = findParentFolder(item.children, url);
                        if (found) return found;
                    }
                }
                return null;
            };

            const removeFile = (items, url) => {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type === 'file' && items[i].url === url) {
                        return items.splice(i, 1)[0];
                    }
                    if (items[i].type === 'folder') {
                        const removed = removeFile(items[i].children, url);
                        if (removed) return removed;
                    }
                }
                return null;
            };

            const checkExists = (folderName, url) => {
                const folder = data.root.find(f => f.name === folderName);
                if (!folder) return false;
                return folder.children.some(c => c.type === 'file' && c.url === url);
            };

            // --- EXECUTE ---
            for (const cmd of batch.commands) {
                
                // 1. ADD
                if (cmd.type === 'add') {
                    // Rule: Reject add if duplicate exists in .private or shared
                    if (cmd.folder !== 'archive' && checkExists(cmd.folder, cmd.payload.url)) {
                        console.log(`Duplicate rejected: ${cmd.payload.url} in ${cmd.folder}`);
                        continue;
                    }

                    const folder = data.root.find(f => f.name === cmd.folder);
                    if (folder) {
                        folder.children.push(cmd.payload);
                        modified = true;
                    }
                }

                // 2. REVIEW (TRIGGER AUTO ARCHIVE)
                else if (cmd.type === 'review') {
                    const file = findFile(data.root, cmd.url);
                    if (file) {
                        // Add Review
                        if (!file.reviews) file.reviews = [];
                        file.reviews = file.reviews.filter(r => r.user !== cmd.user);
                        file.reviews.push({ user: cmd.user, text: cmd.text });
                        modified = true;

                        // Check Auto-Archive Logic
                        const parent = findParentFolder(data.root, cmd.url);
                        
                        // We only auto-archive if it's not already in archive
                        if (parent && parent.name !== 'archive') {
                            let threshold = 1; // Default for .private
                            
                            // If in shared, threshold is number of friends
                            if (parent.name === 'shared') {
                                threshold = (data.friends && data.friends.length > 0) ? data.friends.length : 1;
                            }

                            if (file.reviews.length >= threshold) {
                                console.log(`Auto-archiving ${file.title}. Reviews: ${file.reviews.length}, Threshold: ${threshold}`);
                                const fileObj = removeFile(data.root, cmd.url);
                                const archive = data.root.find(f => f.name === 'archive');
                                // Duplicates allowed in archive, so just push
                                archive.children.push(fileObj);
                            }
                        }
                    }
                }

                // 3. MOVE
                else if (cmd.type === 'move') {
                    // Rule: Reject move if duplicate exists in destination (unless dest is archive)
                    if (cmd.target !== 'archive' && checkExists(cmd.target, cmd.url)) {
                        console.log(`Move rejected: ${cmd.url} already exists in ${cmd.target}`);
                        continue;
                    }

                    const fileObj = removeFile(data.root, cmd.url);
                    if (fileObj) {
                        const targetFolder = data.root.find(f => f.name === cmd.target);
                        if (targetFolder) {
                            targetFolder.children.push(fileObj);
                            modified = true;
                        }
                    }
                }

                // 4. DELETE
                else if (cmd.type === 'delete') {
                    const removed = removeFile(data.root, cmd.url);
                    if (removed) modified = true;
                }
            }

            if (modified) {
                fs.writeFileSync('data.json', JSON.stringify(data, null, 2));
            }

      - name: Commit Changes
        run: |
          git config --global user.name 'BatchBot'
          git config --global user.email 'bot@noreply.github.com'
          git add data.json
          git commit -m "Processed batch ${{ github.event.issue.number }}"
          git push

      - name: Close Issue
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "Batch processed."